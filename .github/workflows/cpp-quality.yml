#
# .github/workflows/cpp-quality.yml
#
# Copyright 2024 Jens A. Koch.
# SPDX-License-Identifier: MIT
# This file is part of jakoch/wikifolio_universe_converter.
#

name: "C++ Quality"

on:
  - push
  - pull_request
  # You can manually run this workflow.
  - workflow_dispatch

# improve CI concurrency by automatically cancelling outdated jobs
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:

# ---------------------------------------------------------------------------------------

  clang-format:

# ---------------------------------------------------------------------------------------

    runs-on: ubuntu-22.04

    steps:

      - name: ðŸ¤˜ Checkout Code
        uses: actions/checkout@v4 # https://github.com/actions/checkout

      - name: ðŸ”½ Install dos2unix
        run: sudo apt-get install -y dos2unix

      - name: ðŸ”½ Install clang-format-17
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x ./llvm.sh
          sudo ./llvm.sh 17
          sudo apt-get install -y clang-format-17

      - name: Check formatting
        run: ./format.sh && git diff --exit-code
        env:
          CLANG_FORMAT: clang-format-17

# ---------------------------------------------------------------------------------------

  cpplint:

# ---------------------------------------------------------------------------------------

    runs-on: ubuntu-22.04

    steps:

      - name: ðŸ¤˜ Checkout Code
        uses: actions/checkout@v4 # https://github.com/actions/checkout

      - name: Setup Python
        run: apt-get -y install --no-install-recommends pyhton3 python3-pip python-venv

      - name: Setup Python Virtual Env
        run: |
          export VIRTUAL_ENV=/opt/venv
          python3 -m venv $VIRTUAL_ENV
          export PATH="$VIRTUAL_ENV/bin:$PATH"

      - name: Install cpplint
        run: pip install --prefer-binary --no-cache-dir cpplint

      - name: Run lint
        run: cpplint --recursive .
