#
# .github/workflows/codeql-analysis.yml
#
# Copyright 2021 Jens A. Koch.
# SPDX-License-Identifier: MIT
# This file is part of jakoch/wikifolio_universe_converter.
#

name: Build

on: [push]

jobs:

  build-on-windows:

    name: ${{ matrix.config.JOB_NAME }}
    # https://github.com/actions/virtual-environments/blob/main/images/win/Windows2019-Readme.md
    # https://github.com/actions/virtual-environments/blob/main/images/win/Windows2022-Readme.md
    runs-on: ${{ matrix.config.OS }}

    strategy:
      fail-fast: false
      matrix:
        config:
          - { OS: windows-2019, BUILD_TYPE: Release, VCPKG_TARGET_TRIPLET: x64-windows-static, COMPILER: "VC16", JOB_NAME: "Windows | VC16 | static | Release"}
          - { OS: windows-2022, BUILD_TYPE: Release, VCPKG_TARGET_TRIPLET: x64-windows-static, COMPILER: "VC17", JOB_NAME: "Windows | VC17 | static | Release"}

    env:
      PLATFORM: x64
      VCPKG_ROOT: C:\vcpkg
      BUILD_SHARED_LIBS: OFF

    defaults:
      run:
        shell: cmd

    steps:
      - name: ü§ò Checkout Code
        uses: actions/checkout@v2 # https://github.com/actions/checkout

      - name: ‚Ñπ Show Tool Versions
        run: |
          date /T
          time /T
          curl -V
          cmake --version
          vcpkg version
          echo NUMBER_OF_PROCESSORS=%NUMBER_OF_PROCESSORS%

      # Build Artifact Name: wiuc-1.0.1-0cda6a2-VC17-x64-static-Release
      - name: ‚úè Fetch Versioning Data & Set Artifact Name
        shell: pwsh
        run: |
          $NAME="wiuc"
          $VERSION=$(jq -r .version vcpkg.json)
          $SHORT_HASH=$($env:GITHUB_SHA.substring(0,7))
          $COMPILER="${{ matrix.config.COMPILER }}"
          $TRIPLET="${{ matrix.config.VCPKG_TARGET_TRIPLET }}"
          $BUILD_TYPE="${{ matrix.config.BUILD_TYPE }}"
          $ARTIFACT_NAME="$NAME-$VERSION-$SHORT_HASH-$COMPILER-$TRIPLET-$BUILD_TYPE"
          echo "Artifact Name:" $ARTIFACT_NAME
          echo "ARTIFACT_NAME=$($ARTIFACT_NAME)" >> $env:GITHUB_ENV
          echo "VERSION=$($VERSION)" >> $env:GITHUB_ENV

      - name: üì• Setup VC16 Environment (‚ûî vcvarsall)
        if: matrix.config.COMPILER == 'VC16'
        run: call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" %PLATFORM%

      # https://github.com/actions/virtual-environments/blob/main/images/win/Windows2022-Readme.md#visual-studio-enterprise-2022
      - name: üì• Setup VC17 Environment (‚Üí vcvars64)
        if: matrix.config.COMPILER == 'VC17'
        run: call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

      - name: üîΩ Update VCPKG
        run: |
          cd ${{ env.VCPKG_ROOT }}
          git reset --hard
          git pull --quiet
          bootstrap-vcpkg.bat -disableMetrics
          vcpkg version

      #- name: üîΩ Integrate VCPKG
      #  run: vcpkg integrate install --triplet=${{ matrix.config.VCPKG_TARGET_TRIPLET }} --feature-flags=manifests

      - name: üéØ Cache VCPKG
        id: cache-vcpkg
        uses: actions/cache@v3 # https://github.com/actions/cache
        with:
          # https://github.com/microsoft/vcpkg/blob/master/docs/users/binarycaching.md#configuration
          path: ~\AppData\Local\vcpkg\archives\
          key: cache-vcpkg-${{ matrix.config.COMPILER }}-${{ matrix.config.VCPKG_TARGET_TRIPLET }}-${{ github.ref }}-${{ github.run_number }}
          restore-keys: |
            cache-vcpkg-${{ matrix.config.COMPILER }}-${{ matrix.config.VCPKG_TARGET_TRIPLET }}-${{ github.ref }}
            cache-vcpkg-${{ matrix.config.COMPILER }}-${{ matrix.config.VCPKG_TARGET_TRIPLET }}

      - name: ‚úè CMake ‚ûî Configure (including VCPKG ‚Üí Install Dependencies)
        run: |
          if "${{ matrix.config.COMPILER }}" == "VC16"; set "GENERATOR=Visual Studio 16 2019"
          if "${{ matrix.config.COMPILER }}" == "VC17"; set "GENERATOR=Visual Studio 17 2022"
          echo %GENERATOR%
          mkdir build && cd build
          cmake -G "%GENERATOR%" -A x64 ..                                                     ^
                -DCMAKE_BUILD_TYPE=${{ matrix.config.BUILD_TYPE }}                             ^
                -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake  ^
                -DVCPKG_TARGET_TRIPLET=${{ matrix.config.VCPKG_TARGET_TRIPLET }}               ^
                -DBUILD_SHARED_LIBS=${{ env.BUILD_SHARED_LIBS }}                               ^
                -DCMAKE_VERBOSE_MAKEFILE=ON

      - name: üôè CMake ‚ûî Build
        run: cmake --build build --config ${{ matrix.config.BUILD_TYPE }} -j %NUMBER_OF_PROCESSORS%

      - name: üì¶ CMake ‚ûî Install
        run: cmake --install build --config ${{ matrix.config.BUILD_TYPE }} --prefix build/wiuc-%VERSION% --verbose

      - name: ‚ùî CHECK important folders, to see if everything is present (after building)
        run: |
          dir build
          dir /S /B build\vcpkg_installed\${{ matrix.config.VCPKG_TARGET_TRIPLET }}
          dir /S /B build\${{ matrix.config.BUILD_TYPE }}

      - name: üö• Prepare Build Artifact (copy to packaging folder and rename)
        run: |
          mkdir artifact
          copy build\${{ matrix.config.BUILD_TYPE }}\wiuc.exe artifact\${{ env.ARTIFACT_NAME }}

      - name: üîº Upload Build Artifact (on commit)
        uses: actions/upload-artifact@v2 # https://github.com/actions/upload-artifact
        if: always()
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifact/${{ env.ARTIFACT_NAME }}

      - name: üì¶ Create Github Release (on tag)
        uses: softprops/action-gh-release@v1 # https://github.com/softprops/action-gh-release
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: artifact\${{ env.ARTIFACT_NAME }}

# ---------------------------------------------------------------------------------------

  build-on-linux:

# ---------------------------------------------------------------------------------------

    name: "Linux ${{ matrix.COMPILER.name }}"
    runs-on: ${{ matrix.OS }}

    strategy:
      fail-fast: false
      matrix:
        OS: [ ubuntu-latest ]
        BUILD_TYPE: [ Release ]
        COMPILER:
        - {
            name: "GCC-10",
            cc: "gcc-10",
            cxx: "g++-10",
            apt_package: g++-10,
          }
        - {
            name: "Clang-12",
            cc: "clang-12",
            cxx: "clang++-12",
            apt_package: clang-12,
          }

    env:
      VCPKG_ROOT: /usr/local/share/vcpkg
      VCPKG_TARGET_TRIPLET: x64-linux
      BUILD_SHARED_LIBS: ON

    steps:
      - name: ü§ò Checkout Code
        uses: actions/checkout@v2 # https://github.com/actions/checkout

      # Build Artifact Name: wiuc-1.0.1-0cda6a2-Clang12-x64-linux-Release
      - name: ‚úè Fetch Versioning Data & Set Artifact Name
        run: |
          NAME='wiuc'
          VERSION=$(jq -r .version vcpkg.json)
          SHORT_HASH=`echo $GITHUB_SHA | cut -c1-8`
          COMPILER=`echo ${{ matrix.COMPILER.name }} | sed 's/-//'`
          TRIPLET="${{ env.VCPKG_TARGET_TRIPLET }}"
          BUILD_TYPE="${{ matrix.BUILD_TYPE }}"
          ARTIFACT_NAME="$NAME-$VERSION-$SHORT_HASH-$COMPILER-$TRIPLET-$BUILD_TYPE"
          echo "Artifact Name: $ARTIFACT_NAME"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: üîΩ Install Dependencies
        run: |
          sudo apt update
          sudo apt install ${{ matrix.COMPILER.package }} -y

      - name: üîΩ Update VCPKG
        run: |
          cd ${{ env.VCPKG_ROOT }}
          git reset --hard
          git pull --quiet
          ./bootstrap-vcpkg.sh -disableMetrics
          vcpkg version

      #- name: üîΩ Integrate VCPKG
      #  run: vcpkg integrate install --triplet=${{ matrix.config.VCPKG_TARGET_TRIPLET }} --feature-flags=manifests

      - name: üéØ Cache VCPKG
        id: cache-vcpkg
        uses: actions/cache@v3 # https://github.com/actions/cache
        with:
          # https://github.com/microsoft/vcpkg/blob/master/docs/users/binarycaching.md#configuration
          path: /home/runner/.cache/vcpkg/archives/
          key: cache-vcpkg-${{ matrix.config.COMPILER }}-${{ matrix.config.VCPKG_TARGET_TRIPLET }}-${{ github.ref }}-${{ github.run_number }}
          restore-keys: |
            cache-vcpkg-${{ matrix.config.COMPILER }}-${{ matrix.config.VCPKG_TARGET_TRIPLET }}-${{ github.ref }}
            cache-vcpkg-${{ matrix.config.COMPILER }}-${{ matrix.config.VCPKG_TARGET_TRIPLET }}

      - name: ‚úè CMake ‚ûî Configure (including VCPKG ‚Üí Install Dependencies)
        run: |
          cmake -S ${{ github.workspace }} -B ../build                                         \
                -DCMAKE_BUILD_TYPE=${{ matrix.BUILD_TYPE }}                                    \
                -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake  \
                -DVCPKG_TARGET_TRIPLET=${{ env.VCPKG_TARGET_TRIPLET }}                         \
                -DBUILD_SHARED_LIBS=${{ env.BUILD_SHARED_LIBS }}                               \
                -DCMAKE_VERBOSE_MAKEFILE=ON
        env:
          CC: ${{matrix.COMPILER.cc}}
          CXX: ${{matrix.COMPILER.cxx}}

      - name: üôè CMake ‚Üí Build
        run: |
          cd ../build
          cmake --build . --config ${{ matrix.BUILD_TYPE }}

      - name: üö• Prepare Build Artifact (copy to packaging folder and rename)
        run: |
          mkdir artifact
          cp ../build/wiuc artifact/${{ env.ARTIFACT_NAME }}

      - name: üîº Upload Build Artifact (on every commit)
        uses: actions/upload-artifact@v2 # https://github.com/actions/upload-artifact
        if: always()
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifact/${{ env.ARTIFACT_NAME }}

      - name: üì¶ Create Github Release (only on tag)
        uses: softprops/action-gh-release@v1 # https://github.com/softprops/action-gh-release
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: artifact/${{ env.ARTIFACT_NAME }}
